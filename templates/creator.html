{% extends "base.html" %}

{% block style %}
.share > div {
    padding: 5px !important;
    border-radius: 5px;
}
{% endblock %}

{% block content %}
<div class="row single share">
    <div class="col s12 valign-wrapper center-align z-depth-1 blue lighten-5">
        <i class="material-icons prefix">share</i>
        <a href="{{ link }}">&nbsp;&nbsp;<b>Share this link</b>&nbsp;&nbsp;</a>
    </div>
</div>
<form id="timer" method="post">
    <input type="hidden" name="key" value="{{ key }}">
</form>
{% endblock %}

{% block action %}
<div class="row first">
    <button class="btn waves-effect waves-light blue-grey lighten-1" id="share">COPY</button>
</div>
<div class="row last">
    <button class="btn waves-effect waves-light" type="submit" form="timer">START</button>
</div>
{% endblock %}

{% block modal %}
<div id="results-modal" class="modal modal-fixed-footer">
    <div class="modal-content">
        <h4>Results</h4>
        <ul class="collection">
            <li id="results-li-min" class="collection-item green lighten-5"></li>
            <li id="results-li-average" class="collection-item yellow lighten-5"></li>
            <li id="results-li-max" class="collection-item red lighten-5"></li>
        </ul>
        <ul id="results-ul-votes" class="collection"></ul>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat"><b>Gotcha!</b></a>
    </div>
</div>
{% endblock %}

{% block script %}
function start(e) {
    let instance = M.Modal.getInstance($('#results-modal').get(0));
    let $form = $(e.currentTarget);
    let $button = $(':submit').closest('[form=' + $form.attr('id') + ']');
    $form.off('submit', start);
    $.ajax({
        url: '/start/',
        type: $form.attr('method'),
        data: $form.serialize(),
    }).done((data) => {
        M.toast({html: 'Voting is started :)', classes: 'rounded'});
        $button.text('STOP');
        $form.on('submit', stop);
    }).fail(() => {
        M.toast({html: 'Oops! Something went wrong :(', classes: 'rounded'});
        $form.on('submit', start);
    });
    e.preventDefault();
};

function stop(e) {
    let instance = M.Modal.getInstance($('#results-modal').get(0));
    let $form = $(e.currentTarget);
    let $button = $(':submit').closest('[form=' + $form.attr('id') + ']');
    $form.off('submit', stop);
    $.ajax({
        url: '/stop/',
        type: $form.attr('method'),
        data: $form.serialize(),
    }).done((data) => {
        if ($.isEmptyObject(data['votes'])) {
            M.toast({html: 'Voting is over. No results :(', classes: 'rounded'});
        } else {
            let $ulVotes = $('#results-ul-votes');
            $ulVotes.empty();
            for (const property in data['votes']) {
                $ulVotes.append(`<li class="collection-item"><b>${property}
                    <span class="badge">${data['votes'][property]}</span>
                </b></li>`);
            };
            $('#results-li-min').html(
                `<b>Min<span class="badge">${data['min']}</span></b>`
            );
            $('#results-li-average').html(
                `<b>Average<span class="badge">${data['average']}</span></b>`
            );
            $('#results-li-max').html(
                `<b>Max<span class="badge">${data['max']}</span></b>`
            );
            instance.open();
        };
        $button.text('START');
        $form.on('submit', start);
    }).fail(() => {
        M.toast({html: 'Oops! Something went wrong :(', classes: 'rounded'});
        $form.on('submit', stop);
    });
    e.preventDefault();
};

$(document).ready(() => {
    let instance = M.Modal.init($('#results-modal').get(0));
    $('form').submit(start);
    $('button#share').click(() => {
        navigator.clipboard.writeText(window.location.origin + '{{ link }}');
        M.toast({html: 'Link is copied to clipboard', classes: 'rounded'});
    });
});
{% endblock %}
